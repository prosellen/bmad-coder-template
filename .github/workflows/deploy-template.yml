name: Deploy Coder Template

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CODER_URL: "http://4.185.233.9/"
  TEMPLATE_NAME: "bmad-vscode"
  # Kubernetes namespace where workspaces will be created
  NAMESPACE: "coder-workspaces"
  # Set to "true" if Coder is running outside the K8s cluster
  USE_KUBECONFIG: "false"
  BMAD_CLI_VERSION: "latest"

jobs:
  validate-and-deploy:
    name: Validate and Deploy Template
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Template version: $VERSION"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.0"

      - name: Validate template Terraform syntax
        run: |
          terraform init -backend=false
          terraform fmt -check
          terraform validate
          echo "âœ… Template validation successful"

      - name: Install Coder CLI
        uses: coder/setup-action@v1

      - name: Create template variables file
        run: |
          cat > template.tfvars <<EOF
          use_kubeconfig   = ${{ env.USE_KUBECONFIG }}
          namespace        = "${{ env.NAMESPACE }}"
          bmad_cli_version = "${{ env.BMAD_CLI_VERSION }}"
          EOF
          echo "ðŸ“ Created template.tfvars with deployment variables"

      - name: Push template to Coder
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          coder template push ${{ env.TEMPLATE_NAME }} \
            --directory . \
            --name "${{ steps.version.outputs.VERSION }}" \
            --var-file template.tfvars \
            --message "Automated deployment via GitHub Actions - v${{ steps.version.outputs.VERSION }}" \
            --yes

      - name: Set template as active
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          echo "âœ… Template deployed successfully!"
          echo "ðŸ“¦ Template: ${{ env.TEMPLATE_NAME }}"
          echo "ðŸ·ï¸  Version: ${{ steps.version.outputs.VERSION }}"
          echo "ðŸ”— View template: ${{ env.CODER_URL }}templates/${{ env.TEMPLATE_NAME }}"
