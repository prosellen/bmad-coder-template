name: Deploy Coder Template

on:
  push:
    # branches:
    #   - main
    tags:
      - "v*"
  workflow_dispatch:

env:
  CODER_URL: ${{ vars.CODER_URL }}
  TEMPLATE_NAME: ${{ vars.TEMPLATE_NAME }}
  # Kubernetes namespace where workspaces will be created
  NAMESPACE: ${{ vars.NAMESPACE }}
  # Set to "true" if Coder is running outside the K8s cluster
  USE_KUBECONFIG: ${{ vars.USE_KUBECONFIG }}
  BMAD_CLI_VERSION: ${{ vars.BMAD_CLI_VERSION }}

jobs:
  validate-and-deploy:
    name: Validate and Deploy Template
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Template version: $VERSION"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ">= 1.2"

      - name: Validate template Terraform syntax
        run: |
          terraform init -backend=false
          terraform fmt -check
          terraform validate
          echo "‚úÖ Template validation successful"

      - name: Extract PR title for release
        id: pr_info
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.groot-preview+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls")

          PR_TITLE=$(echo "$RESPONSE" | jq -r '.[0].title // empty')

          if [ -z "$PR_TITLE" ]; then
            PR_TITLE=$(git show -s --format=%s "${GITHUB_SHA}")
          fi

          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT

      - name: Install Coder CLI
        uses: coder/setup-action@v1.1.0
        with:
          access_url: ${{ env.CODER_URL }}
          coder_session_token: ${{ secrets.CODER_TOKEN }}

      # - name: Create template variables file
      #   run: |
      #     cat > template.tfvars <<EOF
      #     use_kubeconfig   = ${{ env.USE_KUBECONFIG }}
      #     namespace        = "${{ env.NAMESPACE }}"
      #     bmad_cli_version = "${{ env.BMAD_CLI_VERSION }}"
      #     EOF
      #     echo "üìù Created template.tfvars with deployment variables"

      - name: Push template to Coder
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          USE_KUBECONFIG="${USE_KUBECONFIG:-false}"
          BMAD_CLI_VERSION="${BMAD_CLI_VERSION:-latest}"

          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            TEMPLATE_VERSION="${GITHUB_REF_NAME}"
          else
            TEMPLATE_VERSION="${{ steps.version.outputs.VERSION }}"
          fi

          echo "TEMPLATE_VERSION=$TEMPLATE_VERSION" >> $GITHUB_ENV

          PR_TITLE="${{ steps.pr_info.outputs.pr_title }}"
          MESSAGE="Automated deployment via GitHub Actions - ${TEMPLATE_VERSION}"

          if [ -n "$PR_TITLE" ]; then
            MESSAGE="$MESSAGE | PR: $PR_TITLE"
          fi

          coder template push ${{ env.TEMPLATE_NAME }} \
            --directory . \
            --name "${TEMPLATE_VERSION}" \
            --variable "use_kubeconfig=${USE_KUBECONFIG}" \
            --variable "namespace=${{ env.NAMESPACE }}" \
            --variable "bmad_cli_version=${BMAD_CLI_VERSION}" \
            --message "$MESSAGE" \
            --yes

      - name: Set template as active
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          echo "‚úÖ Template deployed successfully!"
          echo "üì¶ Template: ${{ env.TEMPLATE_NAME }}"
          echo "üè∑Ô∏è  Version: $TEMPLATE_VERSION"
          echo "üîó View template: ${{ env.CODER_URL }}templates/${{ env.TEMPLATE_NAME }}"
