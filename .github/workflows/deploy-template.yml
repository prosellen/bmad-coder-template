name: Deploy Coder Template

on:
  push:
    # branches:
    #   - main
    tags:
      - "v*"
  release:
    types: [published]
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:

env:
  # Domain URL of the Coder instance
  CODER_URL: ${{ vars.CODER_URL }}
  # Kubernetes namespace where workspaces will be created
  CODER_NAMESPACE: ${{ vars.CODER_NAMESPACE }}
  # Name of the Coder template to deploy
  TEMPLATE_NAME: ${{ vars.TEMPLATE_NAME }}
  # Set to "true" if Coder is running outside the K8s cluster
  USE_KUBECONFIG: ${{ vars.USE_KUBECONFIG }}
  BMAD_CLI_VERSION: ${{ vars.BMAD_CLI_VERSION }}

jobs:
  validate-and-deploy:
    name: Validate and Deploy Template
    runs-on: ubuntu-latest
    # Only run on successful Release workflow when triggered by workflow_run
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Use the exact source for each event type
          # - release: checkout the release tag
          # - push tag: checkout the tag ref
          # - workflow_run: checkout the head_sha from the Release workflow
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || (github.event_name == 'push' && github.ref || github.event.workflow_run.head_sha) }}

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Template version: $VERSION"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ">= 1.2"

      - name: Validate template Terraform syntax
        run: |
          terraform init -backend=false
          # Show formatting diffs but don't fail the workflow on fmt issues
          if ! terraform fmt -check -diff -recursive; then
            echo "::warning title=Terraform formatting::Some files need 'terraform fmt -recursive'"
          fi
          terraform validate
          echo "‚úÖ Template validation successful"

      - name: Extract PR title for release
        id: pr_info
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.groot-preview+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls")

          PR_TITLE=$(echo "$RESPONSE" | jq -r '.[0].title // empty')

          if [ -z "$PR_TITLE" ]; then
            PR_TITLE=$(git show -s --format=%s "${GITHUB_SHA}")
          fi

          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT

      - name: Install Coder CLI
        uses: coder/setup-action@v1.1.0
        with:
          access_url: ${{ env.CODER_URL }}
          coder_session_token: ${{ secrets.CODER_TOKEN }}

      # - name: Create template variables file
      #   run: |
      #     cat > template.tfvars <<EOF
      #     use_kubeconfig   = ${{ env.USE_KUBECONFIG }}
      #     namespace        = "${{ env.CODER_NAMESPACE }}"
      #     bmad_cli_version = "${{ env.BMAD_CLI_VERSION }}"
      #     EOF
      #     echo "üìù Created template.tfvars with deployment variables"

      - name: Push template to Coder
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
          # Available on release events; empty otherwise
          RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          USE_KUBECONFIG="${USE_KUBECONFIG:-false}"
          BMAD_CLI_VERSION="${BMAD_CLI_VERSION:-latest}"

          # Determine version based on event type
          if [ "${GITHUB_EVENT_NAME}" = "release" ] && [ -n "${RELEASE_TAG_NAME}" ]; then
            TEMPLATE_VERSION="${RELEASE_TAG_NAME}"
          elif [ "${GITHUB_REF_TYPE}" = "tag" ] && [ -n "${GITHUB_REF_NAME}" ]; then
            TEMPLATE_VERSION="${GITHUB_REF_NAME}"
          elif [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            # Fallback: fetch latest release tag (assumes Release workflow just published it)
            TEMPLATE_VERSION=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name // empty')
            if [ -z "$TEMPLATE_VERSION" ]; then
              TEMPLATE_VERSION="${{ steps.version.outputs.VERSION }}"
            fi
          else
            TEMPLATE_VERSION="${{ steps.version.outputs.VERSION }}"
          fi

          echo "TEMPLATE_VERSION=$TEMPLATE_VERSION" >> $GITHUB_ENV

          PR_TITLE="${{ steps.pr_info.outputs.pr_title }}"
          MESSAGE="Automated deployment via GitHub Actions - ${TEMPLATE_VERSION}"

          if [ -n "$PR_TITLE" ]; then
            MESSAGE="$MESSAGE | PR: $PR_TITLE"
          fi

          coder template push ${{ env.TEMPLATE_NAME }} \
            --directory . \
            --name "${TEMPLATE_VERSION}" \
            --variable "use_kubeconfig=${USE_KUBECONFIG}" \
            --variable "namespace=${{ env.CODER_NAMESPACE }}" \
            --variable "bmad_cli_version=${BMAD_CLI_VERSION}" \
            --message "$MESSAGE" \
            --yes

      - name: Set template as active
        env:
          CODER_URL: ${{ env.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_TOKEN }}
        run: |
          echo "‚úÖ Template deployed successfully!"
          echo "üì¶ Template: ${{ env.TEMPLATE_NAME }}"
          echo "üè∑Ô∏è  Version: $TEMPLATE_VERSION"
          echo "üîó View template: ${{ env.CODER_URL }}templates/${{ env.TEMPLATE_NAME }}"
